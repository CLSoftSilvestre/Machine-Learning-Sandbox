{% extends 'base.html' %}

{% block title %} Data Studio {% endblock %}

{% block content %}

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.48.4/codemirror.min.css">
<link rel="stylesheet" href="https://codemirror.net/5/theme/monokai.css" /> 
<script src="https://cdn.jsdelivr.net/pyodide/v0.18.1/full/pyodide.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.63.3/codemirror.min.js" integrity="sha512-XMlgZzPyVXf1I/wbGnofk1Hfdx+zAWyZjh6c21yGo/k1zNC4Ve6xcQnTDTCHrjFGsOrVicJsBURLYktVEu/8vQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script> 
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.63.3/mode/python/python.min.js" integrity="sha512-/mavDpedrvPG/0Grj2Ughxte/fsm42ZmZWWpHz1jCbzd5ECv8CB7PomGtw0NAnhHmE/lkDFkRMupjoohbKNA1Q==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js" type="text/javascript"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script type="text/javascript" src="https://unpkg.com/@sgratzl/chartjs-chart-boxplot@3.6.0/build/index.umd.min.js"></script>
<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/chartjs-chart-matrix@1.1.0/dist/chartjs-chart-matrix.min.js"></script>
<script type="text/javascript" src="../static/js/polyfit.js"></script>
<script src="../static/js/color-blend.js"></script>
<link href="../static/css/console.css" rel="stylesheet">

<!-- content -->
<h3 class="m-4" id="tr_data_studio">Data Studio</h3>
<div class="row">
    <div class="col-12">
        <!-- Import dataset or use dummy data for training purposes -->
        {% if not uploaded %}
        <div class="card bg-light ms-4 me-4 mb-4">
            <div class="card-header">
                <h3 id="notuploaded"><span id="tr_load_dataset">Load CSV dataset</span></h3>     
            </div>
            <div class="card-body">             
                <form action="/uploader/" method="POST" enctype="multipart/form-data">
                    <div class="form-group row">
                        <label for="file" class="col-sm-1 col-form-label"><span id="tr_select_file">Select file</span></label>
                        <div class="col-sm-5" id="tour-train-import-file">
                            <input type="file" class="form-control text-left" name = "file" id="file" accept=".csv">
                        </div>

                        <label for="sep" class="col-sm-1 col-form-label"><span id="tr_separator">Separator</span></label>
                        <div class="col-sm-1" id="tour-train-import-separator">
                            <input type="text" class="form-control text-left" name = "sep" id="sep" value=";">
                        </div>

                        <!--label for="sep" class="col-sm-1 col-form-label">Separator</label>
                        <div class="col-sm-1">
                            <select class="form-select form-select-sm" name="sep" id="sep">
                                <option value=";">Semicolon</option>
                                <option value=",">Comma</option>
                            </select>
                        </div-->

                        <label for="dec" class="col-sm-1 col-form-label"><span id="tr_decimal">Decimal</span></label>
                        <div class="col-sm-1" id="tour-train-import-decimal">
                            <input type="text" class="form-control text-left" name = "dec" id="dec" value=",">
                        </div>

                        <!--label for="dec" class="col-sm-1 col-form-label">Decimal</label>
                        <div class="col-sm-1">
                            <select class="form-select form-select-sm" name="dec" id="dec">
                                <option value=",">Comma</option>
                                <option value=".">Point</option>
                            </select>
                        </div-->

                        <div class="col-sm-2 text-center">
                            <button type="submit" class="btn btn-primary" id="tour-train-import-parse"><i class="fas fa-file-import"></i><span id="tr_parse_csv"> Parse CSV</span></button>
                        </div>

                    </div>
                </form>
            </div>   
        </div>

        {% if app_config.useOsisoftConnector == True %}
        <form action="/osisoftdata/" method="POST">
            <div class="card bg-light ms-4 me-4 mb-4">
                <div class="card-header">
                    <h3 id="notuploadedosisoft"><span id="tr_load_osisoft">Load from OSIsoft</span></h3>     
                </div>
                <div class="card-body">
                    
                    <div class="form-group row">
                        <label for="startdate" class="col-sm-1 col-form-label"><span id="tr_start_date">Start date</span></label>
                        <div class="col-sm-3" id="tour-train-import-start-date">
                            <input type="date" class="form-control text-left" name = "startdate" id="startdate">
                        </div>

                        <label for="enddate" class="col-sm-1 col-form-label"><span id="tr_end_date">End date</span></label>
                        <div class="col-sm-3" id="tour-train-import-end-date">
                            <input type="date" class="form-control text-left" name = "enddate" id="enddate">
                        </div>

                        <label for="interval" class="col-sm-1 col-form-label"><span id="tr_interval">Interval</span></label>
                        <div class="col-sm-3" id="tour-train-import-interval">
                            <select class="form-select" id="interval" name="interval">
                                <option selected value="15m">15 minutes</option>   
                                <option value="30m">30 minutes</option>
                                <option value="1h">1 hour</option>
                                <option value="8h">8 hours</option>
                                <option value="1d">1 day</option>
                            </select>
                        </div>

                    </div>

                    <hr>

                    <div class="form-group row">

                        <div class="table-responsive" style="overflow-x: hidden; overflow-y: auto;">
                            <table class="table table-hover">
                                <thead>
                                <tr>
                                    <th scope="col">#</th>
                                    <th scope="col" style="width: 70%;">PI Point</th>
                                    <th scope="col">Calculation mode</th>
                                </tr>
                                </thead>
                                <tbody>
                                <tr>
                                    <td>1</td>
                                    <td>
                                        <input type="text" class="form-control text-left" name = "pipointname1" id="pipointname1">
                                    </td>
                                    <td>
                                        <select class="form-select" id="calculation1" name="calculation1">
                                            <option selected value="last value">None (last value)</option>
                                            <option value="total">Total</option>   
                                            <option value="minimum">Minimum</option>
                                            <option value="maximum">Maximum</option>
                                            <option value="standard deviation">Standard deviation</option>
                                            <option value="range">Range</option>
                                            <option value="count">Count</option>
                                            <option value="average time-weighted">Average</option>
                                            <!--option value="average event-weighted">Average (Event-weighted)</option-->
                                        </select>
                                    </td>
                                </tr>
                                <tr>
                                    <td>2</td>
                                    <td>
                                        <input type="text" class="form-control text-left" name = "pipointname2" id="pipointname2">
                                    </td>
                                    <td>
                                        <select class="form-select" id="calculation2" name="calculation2">
                                            <option selected value="last value">None (last value)</option>
                                            <option value="total">Total</option>  
                                            <option value="minimum">Minimum</option>
                                            <option value="maximum">Maximum</option>
                                            <option value="standard deviation">Standard deviation</option>
                                            <option value="range">Range</option>
                                            <option value="count">Count</option>
                                            <option value="average time-weighted">Average</option>
                                            <!--option value="average event-weighted">Average (Event-weighted)</option-->
                                        </select>
                                    </td>
                                </tr>
                                <tr>
                                    <td>3</td>
                                    <td>
                                        <input type="text" class="form-control text-left" name = "pipointname3" id="pipointname3">
                                    </td>
                                    <td>
                                        <select class="form-select" id="calculation3" name="calculation3">
                                            <option selected value="last value">None (last value)</option>
                                            <option value="total">Total</option>  
                                            <option value="minimum">Minimum</option>
                                            <option value="maximum">Maximum</option>
                                            <option value="standard deviation">Standard deviation</option>
                                            <option value="range">Range</option>
                                            <option value="count">Count</option>
                                            <option value="average time-weighted">Average</option>
                                            <!--option value="average event-weighted">Average (Event-weighted)</option-->
                                        </select>
                                    </td>
                                </tr>
                                <tr>
                                    <td>4</td>
                                    <td>
                                        <input type="text" class="form-control text-left" name = "pipointname4" id="pipointname4">
                                    </td>
                                    <td>
                                        <select class="form-select" id="calculation4" name="calculation4">
                                            <option selected value="last value">None (last value)</option>
                                            <option value="total">Total</option>   
                                            <option value="minimum">Minimum</option>
                                            <option value="maximum">Maximum</option>
                                            <option value="standard deviation">Standard deviation</option>
                                            <option value="range">Range</option>
                                            <option value="count">Count</option>
                                            <option value="average time-weighted">Average</option>
                                            <!--option value="average event-weighted">Average (Event-weighted)</option-->
                                        </select>
                                    </td>
                                </tr>
                                <tr>
                                    <td>5</td>
                                    <td>
                                        <input type="text" class="form-control text-left" name = "pipointname5" id="pipointname5">
                                    </td>
                                    <td>
                                        <select class="form-select" id="calculation5" name="calculation5">
                                            <option selected value="last value">None (last value)</option>
                                            <option value="total">Total</option>   
                                            <option value="minimum">Minimum</option>
                                            <option value="maximum">Maximum</option>
                                            <option value="standard deviation">Standard deviation</option>
                                            <option value="range">Range</option>
                                            <option value="count">Count</option>
                                            <option value="average time-weighted">Average</option>
                                            <!--option value="average event-weighted">Average (Event-weighted)</option-->
                                        </select>
                                    </td>
                                </tr>
                                </tbody>
                            </table>
                        </div>
 
                    </div>
                </div>
                <div class="card-footer">
                    <div class="col-sm-12 text-center">
                        <button type="submit" class="btn btn-primary" id="tour-train-import-request-osisoft"><i class="fas fa-file-import"></i><span id="tr_request_osisoft"> Request data</span></button>
                    </div>
                </div>
            </div>
        </form>
        {% endif %}

        <!-- When data is already imported -->
        {% else %}
        <div class="card bg-light ms-4 me-4 mb-4">
            <div class="card-header">
                
                <!-- Functionalities buttons -->
                <div class="d-flex flex-row gap-3">

                    <a class="btn btn-warning" type="button" href="{{ url_for('cleardataset')}}" id="tour-train-import-delete-dataset"><i class="fas fa-eraser"></i><span id="tr_delete_dataset"> Delete dataset</span></a>

                    <form method="post">
                        <input hidden type="text" name="mod" value="clearnull">
                        <input hidden type="text" name="column" value="all">
                        <!--a class="btn btn-primary" type="submit"><i class="fas fa-bath"></i> Clear nulls</a-->
                        <button type="submit" class="btn btn-primary" id="tour-train-import-clear-nulls"><i class="fas fa-bath"></i><span id="tr_clear_nulls"> Clear nulls</span></button>
                    </form>

                    <a href="#" type="button" class="btn btn-primary" data-toggle="tooltip" title="Script" data-bs-toggle="modal" data-bs-target="#script" id="tour-train-import-script"><i class="fa fa-code"></i><span id="tr_python_code"> Python code</span></a>

                    <a href="#" type="button" class="btn btn-primary" data-toggle="tooltip" title="Correlation" data-bs-toggle="modal" data-bs-target="#correlation" id="tour-train-correlation"><i class="fa fa-table"></i><span id="tr_correlation_matrix"> Correlation matrix</span></a>

                    <a href="#" type="button" class="btn btn-primary" data-toggle="tooltip" title="Scatter" data-bs-toggle="modal" data-bs-target="#scatterplot" id="tour-train-scatter"><i class="fa fa-chart-line"></i><span id="tr_scatter_plot"> Scatter plot</span></a>

                    
                    {% if config.usePyGWalker %}
                    <a href="#" type="button" class="btn btn-primary" data-toggle="tooltip" title="Visualization" data-bs-toggle="modal" data-bs-target="#visualization" id="tour-train-visual"><i class="fa fa-binoculars"></i><span id="tr_data_exploration"> Data Exploration</span></a>
                    {% endif %}

                    <a class="btn btn-primary" type="button" href="{{ url_for('downloaddatastudio')}}" id="tour-train-import-export"><i class="fas fa-download"></i><span id="tr_download_this_dataset"> Download this dataset</span></a>

                    <form method="post">
                        <input hidden type="text" name="mod" value="usedataset">
                        <!--a class="btn btn-primary" type="submit"><i class="fas fa-bath"></i> Clear nulls</a-->
                        <button type="submit" class="btn btn-primary" id="tour-train-import-useml"><i class="fas fa-robot"></i><span id="tr_use_for_ml"> Use dataset for ML model training</span></button>
                    </form>

                </div>
                    
            </div>
            <div class="card-body">
                <ul class="nav nav-tabs" id="myTab" role="tablist">

                    <li class="nav-item" role="presentation" id="tour-train-import-desc">
                        <button class="nav-link" id="descri-tab" data-bs-toggle="tab" data-bs-target="#descri" type="button" role="tab" aria-controls="descri" aria-selected="false"><span id="tr_data_statistics">Data statistics</span></button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="types-tab" data-bs-toggle="tab" data-bs-target="#types" type="button" role="tab" aria-controls="types" aria-selected="true"><span id="tr_data_manipulator">Data manipulator</span></button>
                    </li>
                    <li class="nav-item" role="presentation" id="tour-train-import-outliers">
                        <button class="nav-link" id="outliers-tab" data-bs-toggle="tab" data-bs-target="#outliers" type="button" role="tab" aria-controls="resume" aria-selected="false"><span id="tr_boxplot_boards">Boxplots board</span></button>
                    </li>
                    <li class="nav-item" role="presentation" id="tour-train-import-operations">
                        <button class="nav-link" id="dataoperations-tab" data-bs-toggle="tab" data-bs-target="#dataoperations" type="button" role="tab" aria-controls="dataoperations" aria-selected="false"><span id="tr_data_operations">Data operations</span></button>
                    </li>
                </ul>
                <div class="tab-content" id="myTabContent">
                    <div class="tab-pane fade" id="descri" role="tabpanel" aria-labelledby="descri-tab">
                        <p class="card-text">
                            <div class="table-responsive">
                                {% for table in descTable %}
                                    {{ table|safe }}
                                {% endfor %}
                            </div>  
                        </p> 
                    </div>
                    <div class="tab-pane fade show active" id="types" role="tabpanel" aria-labelledby="types-tab">
                        <p class="card-text">
                            <div class="table-responsive">
                                <table class="table table-bordered text-center">
                                    <thead>
                                        <tr id='tour-train-import-variables'>
                                            <th scope="col"><span id="tr_variable">Variable</span></th>
                                            {% for title in titles %}
                                                <th scope="col">{{title}}</th>
                                            {% endfor %}
                                            <!--th scope="col"></th-->
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr id='tour-train-import-datatypes'>
                                            <td class="align-middle" scope="col"><span id="tr_current_data_type">Current data type</span></td>
                                            {% for dtype in datatypes %}
                                                {% if dtype == "object" %}
                                                    <td class="align-middle"><span class="badge bg-warning">{{dtype}}</span></td>
                                                {% else %}
                                                    <td class="align-middle"><span class="badge bg-success">{{dtype}}</span></td>
                                                {% endif %}
                                                
                                            {% endfor %}
                                            <!--td></td-->
                                        </tr>
                                        <tr id='tour-train-import-settype'>
                                            <td class="align-middle"><span id="tr_set_datatype">Set data type</span></td>
                                            {% for title in titles %}
                                                <td class="align-middle">
                                                    <a href="#" type="button" class="btn btn-warning" data-toggle="tooltip" title="Set datatype" data-bs-toggle="modal" data-bs-target="#setTypeConfirmation{{title|replace(' ','')}}"><i class="fa fa-gear"></i></a>
                                                </td>
                                                <!-- set Datatype Modal -->
                                                <div class="modal fade" id="setTypeConfirmation{{title|replace(' ','')}}" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="setDatatypeConfirmationLabel" aria-hidden="true">
                                                    <div class="modal-dialog modal-dialog-centered">

                                                        <div class="modal-content">
                                                            <form method="post">
                                                                <div class="modal-header">
                                                                    <h5 class="modal-title" id="setDatatypeConfirmationLabel"><span id="tr_msg_sure_change_type">Are you sure you want to change the type of data of column</span><b> {{title}}</b> ?</h5>
                                                                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                                                </div>

                                                                <div class="modal-body">
                                                                    <input hidden type="text" name="mod" value="setdatatype">
                                                                    <input hidden type="text" name="column" value="{{title}}">

                                                                    <div class="form-horizontal">
                                                                        <div class="form-group row">
                                                                            <!-- Data type -->
                                                                            <label for="coldatatype" class="col-sm-5 col-form-label"><span id="tr_new_data_type">New data type</span></label>
                                                                            <div class="col-sm-7">
                                                                                <!--input type="number" class="form-control text-left" id="coldataype" name="coldataype"></input-->
                                                                                <select class="form-control text-left" id="coldatatype" name="coldatatype">
                                                                                    <option value="datetime" id="tr_datetime">Datetime</option>
                                                                                    <option value="int" id="tr_integer">Integer</option>
                                                                                    <option value="float" id="tr_float">Float</option>
                                                                                </select>
                                                                            </div>
                                                                        </div>

                                                                    </div>

                                                                    <div>&MediumSpace;</div>

                                                                    <p>⚠️ <span id="tr_msg_you_can_revert">You can revert this action by deleting this operation in the Data Operations tab.</span></p>

                                                                </div>

                                                                <div class="modal-footer">
                                                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal"><span id="tr_cancel">Cancel</span></button>
                                                                    <button type="submit" class="btn btn-success"><i class="fas fa-check"></i></button>
                                                                </div>
                                                            </form>
                                                        </div>
                                                    </div>
                                                </div>
                                            {% endfor %}
                                            <!--td></td-->
                                        </tr>
                                        <tr id='tour-train-import-remove'>
                                            <td class="align-middle"><span id="tr_remove_column">Remove column</span></td>
                                            {% for title in titles %}
                                                <td class="align-middle">
                                                    <a href="#" type="button" class="btn btn-danger" data-toggle="tooltip" title="Filter column" data-bs-toggle="modal" data-bs-target="#deleteConfirmation{{title|replace(' ','')}}"><i class="fa fa-trash"></i></a>
                                                </td>
                                                <!-- column Filter Modal -->
                                                <div class="modal fade" id="deleteConfirmation{{title|replace(' ','')}}" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="deleteConfirmationLabel" aria-hidden="true">
                                                    <div class="modal-dialog modal-dialog-centered">

                                                        <div class="modal-content">
                                                            <form method="post">
                                                                <div class="modal-header">
                                                                    <h5 class="modal-title" id="deleteConfirmationLabel"><span id="tr_msg_sure_delete_column">Are you sure you want to remove the column</span><b> {{title}}</b> ?</h5>
                                                                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                                                </div>

                                                                <div class="modal-body">
                                                                    <input hidden type="text" name="mod" value="remcol">
                                                                    <input hidden type="text" name="column" value="{{title}}">

                                                                    <p>⚠️ <span id="tr_msg_you_can_revert">You can revert this action by deleting this operation in the Data Operations tab.</span></p>

                                                                </div>

                                                                <div class="modal-footer">
                                                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal"><span id="tr_cancel">Cancel</span></button>
                                                                    <button type="submit" class="btn btn-danger"><i class="fas fa-trash"></i></button>
                                                                </div>
                                                            </form>
                                                        </div>
                                                    </div>
                                                </div>
                                            {% endfor %}
                                            <!--td></td-->
                                        </tr>
                                        <tr id='tour-train-import-filter'>
                                            <td class="align-middle"><span id="tr_filter_column">Filter column</span></td>
                                            {% for title in titles %}
                                                {% if datatypes[loop.index0] == 'int64' or datatypes[loop.index0] == 'int32' or datatypes[loop.index0] == 'float64' or datatypes[loop.index0] == 'uint8' %}
                                                <td class="align-middle">
                                                    <a href="#" type="button" class="btn btn-warning" data-toggle="tooltip" title="Filter column" data-bs-toggle="modal" data-bs-target="#filterConfirmation{{title|replace(' ','')}}"><i class="fa fa-filter"></i></a>
                                                </td>
                                                {% else %}
                                                <td class="align-middle">
                                                    <a href="#" type="button" class="btn btn-warning disabled" data-toggle="tooltip" title="Filter column"><i class="fa fa-filter"></i></a>
                                                </td>
                                                {% endif %}

                                                <!-- column Filter Modal -->
                                                <div class="modal fade" id="filterConfirmation{{title|replace(' ','')}}" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="filterConfirmationLabel" aria-hidden="true">
                                                    <div class="modal-dialog modal-dialog-centered">

                                                        <div class="modal-content">
                                                            <form method="post">
                                                                <div class="modal-header">
                                                                    <h5 class="modal-title" id="filterConfirmationLabel"><span id="tr_msg_filter_data_column">Filter the data of column</span><b> {{title}}</b></h5>
                                                                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                                                </div>

                                                                <div class="modal-body">
                                                                    <input hidden type="text" name="mod" value="filtercol">
                                                                    <input hidden type="text" name="column" value="{{title}}">
                                                                    
                                                                    <div class="form-horizontal">
                                                                        <div class="form-group row">
                                                                            <!-- Operator -->
                                                                            <!--label for="minimum" class="col-sm-5 col-form-label">Minimum value inclusive</label>
                                                                            <div class="col-sm-7">
                                                                                <input type="number" class="form-control text-left" id="minimum" name="minimum" step="0.1"></input>
                                                                            </div-->

                                                                            <!-- Operator -->
                                                                            <label for="operatortype" class="col-sm-5 col-form-label"><span id="tr_operator">Operator</span></label>
                                                                            <div class="col-sm-7">
                                                                                <!--input type="number" class="form-control text-left" id="coldataype" name="coldataype"></input-->
                                                                                <select class="form-control text-left" id="operatortype" name="operatortype">
                                                                                    <option value="<">&lt;</option>
                                                                                    <option value="<=">&lt;=</option>
                                                                                    <option value=">">&gt;</option>
                                                                                    <option value=">=">&gt;=</option>
                                                                                </select>
                                                                            </div>

                                                                            <div>&MediumSpace;</div>
    
                                                                            <!-- Value -->
                                                                            <label for="filtervalue" class="col-sm-5 col-form-label"><span id="tr_value">Value</span></label>
                                                                            <div class="col-sm-7">
                                                                                <input type="number" class="form-control text-left" id="filtervalue" name="filtervalue" step="0.01"></input>
                                                                            </div>
                                                                        </div>

                                                                    </div>

                                                                    <div>&MediumSpace;</div>


                                                                </div>

                                                                <div class="modal-footer">
                                                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal"><span id="tr_cancel">Cancel</span></button>
                                                                    <button type="submit" class="btn btn-success"><i class="fas fa-check"></i></button>
                                                                </div>
                                                            </form>
                                                        </div>
                                                    </div>
                                                </div>
                                            {% endfor %}
                                            <!--td></td-->
                                        </tr>
                                        <tr id='tour-train-rem-ouliers'>
                                            <td class="align-middle"><span id="tr_remove_outliers">Remove outliers</span></td>
                                            {% for title in titles %}
                                                {% if datatypes[loop.index0] == 'int64' or datatypes[loop.index0] == 'int32' or datatypes[loop.index0] == 'float64' or datatypes[loop.index0] == 'uint8' %}
                                                <td class="align-middle">
                                                    <a href="#" type="button" class="btn btn-warning" data-toggle="tooltip" title="Remove outliers" data-bs-toggle="modal" data-bs-target="#removeOutliers{{title|replace(' ','')}}"><i class="fa fa-bug"></i></a>
                                                </td>
                                                {% else %}
                                                <td class="align-middle">
                                                    <a href="#" type="button" class="btn btn-warning disabled" data-toggle="tooltip" title="Remove outliers"><i class="fa fa-bug"></i></a>
                                                </td>
                                                {% endif %}

                                                <!-- remove outliers Modal -->
                                                <div class="modal fade" id="removeOutliers{{title|replace(' ','')}}" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="removeOutliersLabel" aria-hidden="true">
                                                    <div class="modal-dialog modal-dialog-centered">

                                                        <div class="modal-content">
                                                            <form method="post">
                                                                <div class="modal-header">
                                                                    <h5 class="modal-title" id="removeOutliersLabel"><span id="tr_msg_remove_outliers">Remove outliers from column</span><b> {{title}}</b></h5>
                                                                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                                                </div>

                                                                <div class="modal-body">
                                                                    <input hidden type="text" name="mod" value="remoutliers">
                                                                    <input hidden type="text" name="column" value="{{title}}">
                                                                    
                                                                    <div class="form-horizontal">
                                                                        <div class="form-group row">

                                                                            <div class="col-sm-12">
                                                                                <div class="form-check form-switch">
                                                                                    <input id="upperOutliers" class="form-check-input" type="checkbox" name="upperOutliers" checked>
                                                                                    <label for="upperOutliers" class="form-check-label"><span id="tr_upper_outlier">Remove upper outliers</span></label>
                                                                                </div>
                                                                            </div>
                                                                            
                                                                            <div class="col-sm-12">
                                                                                <div class="form-check form-switch">
                                                                                    <input id="lowerOutliers" class="form-check-input" type="checkbox" name="lowerOutliers" checked>
                                                                                    <label for="lowerOutliers" class="form-check-label"><span id="tr_lower_outlier">Remove lower outliers</span></label>
                                                                                </div>
                                                                            </div>

                                                                        </div>
                                                                    </div>

                                                                </div>

                                                                <div class="modal-footer">
                                                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal"><span id="tr_cancel">Cancel</span></button>
                                                                    <button type="submit" class="btn btn-success"><i class="fas fa-check"></i></button>
                                                                </div>
                                                            </form>
                                                        </div>
                                                    </div>
                                                </div>
                                            {% endfor %}
                                            <!--td></td-->
                                        </tr>
                                        <tr id='tour-train-import-setname'>
                                            <td class="align-middle"><span id="tr_set_data_name">Set data name</span></td>
                                            {% for title in titles %}
                                                <td class="align-middle">
                                                    <a href="#" type="button" class="btn btn-success" data-toggle="tooltip" title="Set name" data-bs-toggle="modal" data-bs-target="#setName{{title|replace(' ','')}}"><i class="fa fa-pen-to-square"></i></a>
                                                </td>
                                                <!-- set Name Modal -->
                                                <div class="modal fade" id="setName{{title|replace(' ','')}}" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="setNameLabel" aria-hidden="true">
                                                    <div class="modal-dialog modal-dialog-centered">

                                                        <div class="modal-content">
                                                            <form method="post">
                                                                <div class="modal-header">
                                                                    <h5 class="modal-title" id="setNameLabel"><span id="tr_msg_change_name">Are you sure you want to change the name of column</span><b> {{title}}</b> ?</h5>
                                                                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                                                </div>

                                                                <div class="modal-body">
                                                                    <input hidden type="text" name="mod" value="setname">
                                                                    <input hidden type="text" name="column" value="{{title}}">

                                                                    <div class="form-horizontal">
                                                                        <div class="form-group row">
                                                                            <!-- New name -->
                                                                            <label for="minimum" class="col-sm-5 col-form-label"><span id="tr_new_name">Column new name</span></label>
                                                                            <div class="col-sm-7">
                                                                                <input type="text" class="form-control text-left" id="newname" name="newname" value="{{title}}"></input>
                                                                            </div>

                                                                            <div>&MediumSpace;</div>
    
                                                                        </div>

                                                                    </div>

                                                                    <div>&MediumSpace;</div>

                                                                    <p>⚠️ <span id="tr_msg_you_can_revert">You can revert this action by deleting this operation in the Data Operations tab.</span></p>

                                                                </div>

                                                                <div class="modal-footer">
                                                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal"><span id="tr_cancel">Cancel</span></button>
                                                                    <button type="submit" class="btn btn-success"><i class="fas fa-check"></i></button>
                                                                </div>
                                                            </form>
                                                        </div>
                                                    </div>
                                                </div>
                                            {% endfor %}
                                            <!--td></td-->
                                        </tr>
                                    </tbody>
                                </table>

                            </div>  
                        </p>
                    </div>
                    <div class="tab-pane fade" id="outliers" role="tabpanel" aria-labelledby="outliers-tab">
                        <!--img src="data:image/jpeg;base64,{{outliers}}" class="img-fluid" alt="..." id="outliersimg"-->
                        <br>
                        <div class="row">
                            {% for title in titles %}
                                <!--Boxplot -->
                                <div class="col-md-4">
                                    <div class="card">
                                        <div class="card-header">
                                            <b>{{title}}</b> <span id="tr_boxplot_outliers">boxplot and outliers</span>
                                        </div>
                                        <div class="card-body">
                                            <canvas id="Boxplot{{loop.index0}}"></canvas>
                                        </div>
                                    </div>
                                    
                                </div>
                                <script>

                                    //Prepare Dataset
                                    {% set titleLoop = loop.index0 %}

                                    jsBoxData{{titleLoop}} = []
                                    {% if rawdata is defined %}
                                        {% for row in rawdata %}
                                            jsBoxData{{titleLoop}}.push({{row[titleLoop]}})
                                        {% endfor %}
                                    {% endif %}

                                    // Data
                                    var data = {
                                        labels: ['{{title}}'],
                                        datasets: [{
                                            label: '{{title}}',
                                            outlierColor: '#999999',
                                            //padding: 10,
                                            data: [
                                                jsBoxData{{titleLoop}}
                                            ],
                                            medianColor: 'rgba(1, 167, 203, 1)',
                                            backgroundColor: '#D9EDE7',
                                            borderColor: '#005C44',
                                            borderWidth: 2
                                        }]
                                    };

                                    // Configure item size according ammount o items.
                                    var itemSize{{titleLoop}} = 0;
                                    if (jsBoxData{{titleLoop}}.length > 1000){
                                        var itemSize{{titleLoop}} = 1;
                                    } else if (jsBoxData{{titleLoop}}.length < 500) {
                                        var itemSize{{titleLoop}} = 4;
                                    } else {
                                        var itemSize{{titleLoop}} = 3;
                                    }

                                    // config 
                                    var config{{loop.index0}} = {
                                        type: 'boxplot',
                                        data,
                                        options: {
                                            minStats: 'min',
                                            maxStats: 'max',
                                            scales: {
                                                y: {
                                                    beginAtZero: false
                                                }
                                            },
                                            plugins: {
                                                legend: {
                                                    display: false
                                                },
                                                tooltip: {
                                                    displayColors: false,
                                                    callbacks: {
                                                        label: (context) => {
                                                            const boxplotValues = [
                                                                `Min: ${context.parsed.min.toFixed(3)}`,
                                                                `Whiskers min: ${context.parsed.whiskerMin.toFixed(3)}`,
                                                                `1Q: ${context.parsed.q1.toFixed(3)}`,
                                                                `3Q: ${context.parsed.q3.toFixed(3)}`,
                                                                `Median: ${context.parsed.median.toFixed(3)}`,
                                                                `Mean: ${context.parsed.mean.toFixed(3)}`,
                                                                `Whiskers max: ${context.parsed.whiskerMax.toFixed(3)}`,
                                                                `Max: ${context.parsed.max.toFixed(3)}`,
                                                                `Outliers count: ${context.parsed.outliers.length}`,

                                                            ];
                                                            return boxplotValues;
                                                        }
                                                    }
                                                }
                                            },
                                            elements: {
                                                boxandwhiskers: {
                                                    // Data points styling
                                                    itemRadius: itemSize{{titleLoop}},
                                                    itemHitRadius: 0,
                                                    itemStyle: "triangle",
                                                    // Mean styling
                                                    meanRadius: 5,
                                                    meanBorderColor: "blue",
                                                    meanBorderWidth: 1,
                                                    meanBackgroundColor: "white",
                                                    // Outliers styling
                                                    outlierBorderColor: "red",
                                                    outlierBorderWidth: 1,
                                                    outlierBackgroundColor: "white",
                                                    outlierRadius: 3,
                                                },
                                            },
                                        },
                                    };

                                    // render init block
                                    const chartName{{loop.index0}} = new Chart(
                                        document.getElementById('Boxplot{{loop.index0}}'),
                                        config{{loop.index0}},
                                    );

                                </script>                
                            {% endfor %}
                        </div>
                    </div>
                    <div class="tab-pane fade" id="dataoperations" role="tabpanel" aria-labelledby="dataoperations-tab">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                <tr>
                                    <th scope="col"><span id="tr_pos">Pos</span></th>
                                    <th scope="col"><span id="tr_state">State</span></th>
                                    <th scope="col"></th>
                                    <th scope="col"><span id="tr_operation_type">Operation type</span></th>
                                    <th scope="col"><span id="tr_parameters">Parameters</span></th>
                                    <th scope="col"><span id="tr_actions">Actions</span></th>
                                </tr>
                                </thead>
                                <tbody>
                                    {% for oper in datastudio.operations %}
                                    <tr>
                                        <td style="vertical-align: middle;">{{loop.index}}</td>
                                        <!-- State of run -->
                                                      
                                        {% if oper.error %}
                                        <td style="vertical-align: middle;"><a href="#"><span class="badge rounded-pill bg-danger" data-toggle="tooltip" title="{{oper.errorMessage}}" id="tr_error">Error</span></a></td>
                                        {% elif oper.run %}
                                        <td style="vertical-align: middle;"><a href="#"><span class="badge rounded-pill bg-success" id="tr_success">Success</span></a></td>
                                        {% endif %}

                                        <!-- Operation icon -->
                                        {% if oper.operation == 'setdatatype' %}
                                        <td style="vertical-align: middle;"><i class="fas fa-pen"></i></td>
                                        <td style="vertical-align: middle;"><span id="tr_oper_setdatatype">Set column new data type</span></td>
                                        <td style="vertical-align: middle;">{{oper.params}}</td>
                                        <td style="vertical-align: middle;">
                                            <div class="btn-group" role="group" aria-label="Action commands">
                                                <a href="#" type="button" class="btn btn-success" data-toggle="tooltip" title="Edit operation" data-bs-toggle="modal" data-bs-target="#editOperation{{oper.uuid|replace(' ','')}}"><i class="fa fa-edit"></i></a>
                                                <a href="#" type="button" class="btn btn-danger" data-toggle="tooltip" title="Delete operation" data-bs-toggle="modal" data-bs-target="#deleteOperationConfirmation{{oper.uuid|replace(' ','')}}"><i class="fa fa-trash"></i></a>
                                            </div>   
                                        </td>
                                        {% elif oper.operation == 'remcol' %}
                                        <td style="vertical-align: middle;"><i class="fas fa-eraser"></i></td>
                                        <td style="vertical-align: middle;"><span id="tr_oper_remcol">Column removed</span></td>
                                        <td style="vertical-align: middle;">{{oper.params}}</td>
                                        <td style="vertical-align: middle;">
                                            <div class="btn-group" role="group" aria-label="Action commands">
                                                <a href="#" type="button" class="btn btn-success disabled" data-toggle="tooltip" title="Edit operation" data-bs-toggle="modal" data-bs-target="#editOperation{{oper.uuid|replace(' ','')}}"><i class="fa fa-edit"></i></a>
                                                <a href="#" type="button" class="btn btn-danger" data-toggle="tooltip" title="Delete operation" data-bs-toggle="modal" data-bs-target="#deleteOperationConfirmation{{oper.uuid|replace(' ','')}}"><i class="fa fa-trash"></i></a>
                                            </div>   
                                        </td>
                                        {% elif oper.operation == 'setcolumnname' %}
                                        <td style="vertical-align: middle;"><i class="fas fa-font"></i></td>
                                        <td style="vertical-align: middle;"><span id="tr_oper_setcolname">Column name changed</span></td>
                                        <td style="vertical-align: middle;">Column {{oper.params[0]}} renamed to {{oper.params[1]}}</td>
                                        <td style="vertical-align: middle;">
                                            <div class="btn-group" role="group" aria-label="Action commands">
                                                <a href="#" type="button" class="btn btn-success" data-toggle="tooltip" title="Edit operation" data-bs-toggle="modal" data-bs-target="#editOperation{{oper.uuid|replace(' ','')}}"><i class="fa fa-edit"></i></a>
                                                <a href="#" type="button" class="btn btn-danger" data-toggle="tooltip" title="Delete operation" data-bs-toggle="modal" data-bs-target="#deleteOperationConfirmation{{oper.uuid|replace(' ','')}}"><i class="fa fa-trash"></i></a>
                                            </div>   
                                        </td>
                                        {% elif oper.operation == 'clearnull' %}
                                        <td style="vertical-align: middle;"><i class="fas fa-filter"></i></td>
                                        <td style="vertical-align: middle;"><span id="tr_oper_clearnull">Delete rows with null data</span></td>
                                        <td style="vertical-align: middle;"></td>
                                        <td style="vertical-align: middle;">
                                            <div class="btn-group" role="group" aria-label="Action commands">
                                                <a href="#" type="button" class="btn btn-success disabled" data-toggle="tooltip" title="Edit operation" data-bs-toggle="modal" data-bs-target="#editOperation{{oper.uuid|replace(' ','')}}"><i class="fa fa-edit"></i></a>
                                                <a href="#" type="button" class="btn btn-danger" data-toggle="tooltip" title="Delete operation" data-bs-toggle="modal" data-bs-target="#deleteOperationConfirmation{{oper.uuid|replace(' ','')}}"><i class="fa fa-trash"></i></a>
                                            </div>   
                                        </td>
                                        {% elif oper.operation == 'filtercol' %}
                                        <td style="vertical-align: middle;"><i class="fas fa-filter"></i></td>
                                        <td style="vertical-align: middle;"><span id="tr_oper_filtercol">Filter rows acording column values</span></td>
                                        <td style="vertical-align: middle;">{{oper.params[0]}} {{oper.params[1]}} {{oper.params[2]}}</td>
                                        <td style="vertical-align: middle;">
                                            <div class="btn-group" role="group" aria-label="Action commands">
                                                <a href="#" type="button" class="btn btn-success" data-toggle="tooltip" title="Edit operation" data-bs-toggle="modal" data-bs-target="#editOperation{{oper.uuid|replace(' ','')}}"><i class="fa fa-edit"></i></a>
                                                <a href="#" type="button" class="btn btn-danger" data-toggle="tooltip" title="Delete operation" data-bs-toggle="modal" data-bs-target="#deleteOperationConfirmation{{oper.uuid|replace(' ','')}}"><i class="fa fa-trash"></i></a>
                                            </div>   
                                        </td>
                                        {% elif oper.operation == 'remoutliers' %}
                                        <td style="vertical-align: middle;"><i class="fas fa-bug"></i></td>
                                        <td style="vertical-align: middle;"><span id="tr_oper_remoutliers">Removed column outliers</span></td>
                                        <td style="vertical-align: middle;">Column {{oper.params[0]}}, remove upper: {{oper.params[1]}}, remove lower: {{oper.params[2]}}</td>
                                        <td style="vertical-align: middle;">
                                            <div class="btn-group" role="group" aria-label="Action commands">
                                                <a href="#" type="button" class="btn btn-success" data-toggle="tooltip" title="Edit operation" data-bs-toggle="modal" data-bs-target="#editOperation{{oper.uuid|replace(' ','')}}"><i class="fa fa-edit"></i></a>
                                                <a href="#" type="button" class="btn btn-danger" data-toggle="tooltip" title="Delete operation" data-bs-toggle="modal" data-bs-target="#deleteOperationConfirmation{{oper.uuid|replace(' ','')}}"><i class="fa fa-trash"></i></a>
                                            </div>   
                                        </td>
                                        {% elif oper.operation == 'script' %}
                                        <td style="vertical-align: middle;"><i class="fas fa-code"></i></td>
                                        <td style="vertical-align: middle;"><span id="tr_oper_script">Python script applied</span></td>
                                        <td style="vertical-align: middle;"><code>{{oper.params[0]}}</code></td>
                                        <td style="vertical-align: middle;">
                                            <div class="btn-group" role="group" aria-label="Action commands">
                                                <a href="#" type="button" class="btn btn-success" data-toggle="tooltip" title="Edit operation" data-bs-toggle="modal" data-bs-target="#editOperation{{oper.uuid|replace(' ','')}}"><i class="fa fa-edit"></i></a>
                                                <a href="#" type="button" class="btn btn-danger" data-toggle="tooltip" title="Delete operation" data-bs-toggle="modal" data-bs-target="#deleteOperationConfirmation{{oper.uuid|replace(' ','')}}"><i class="fa fa-trash"></i></a>
                                            </div>   
                                        </td>
                                        {% else %}
                                        <td style="vertical-align: middle;"><i class="fas fa-question"></i></td>
                                        <td style="vertical-align: middle;">{{oper.operation}}</td>
                                        <td style="vertical-align: middle;">{{oper.params}}</td>
                                        <td style="vertical-align: middle;">
                                            <div class="btn-group" role="group" aria-label="Action commands">
                                                <a href="#" type="button" class="btn btn-success" data-toggle="tooltip" title="Edit operation" data-bs-toggle="modal" data-bs-target="#editOperation{{oper.uuid|replace(' ','')}}"><i class="fa fa-edit"></i></a>
                                                <a href="#" type="button" class="btn btn-danger" data-toggle="tooltip" title="Delete operation" data-bs-toggle="modal" data-bs-target="#deleteOperationConfirmation{{oper.uuid|replace(' ','')}}"><i class="fa fa-trash"></i></a>
                                            </div>   
                                        </td>
                                        {% endif %}

                                        <!-- Delete Operation Modal -->
                                        <div class="modal fade" id="deleteOperationConfirmation{{oper.uuid|replace(' ','')}}" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="deleteOperationConfirmationLabel" aria-hidden="true">
                                            <div class="modal-dialog modal-dialog-centered">

                                                <div class="modal-content">
                                                    <form method="post">
                                                        <div class="modal-header">
                                                            <h5 class="modal-title" id="deleteOperationConfirmationLabel"><span id="tr_msg_remove_operation">Are you sure you want to remove the operation</span><b> {{oper.operation}}</b> ?</h5>
                                                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                                        </div>

                                                        <div class="modal-body">
                                                            <input hidden type="text" name="mod" value="deloperation">
                                                            <input hidden type="text" name="uuid" value="{{oper.uuid}}">
                                                            <input hidden type="text" name="pos" value="{{loop.index0}}">

                                                            <p>⚠️ <span id="tr_msg_irreversible_action">This action is irreversible. However you can re-apply the data operation again.</span></p>
                                                            <p><span id="tr_oper_uuid">Operation UUID:</span> {{oper.uuid}}</p>
                                                            <p><span id="tr_oper_type">Operation Type:</span> {{oper.operation}}</p>
                                                            <p><span id="tr_oper_params">Operation Parameters:</span> {{oper.params}}</p>

                                                        </div>

                                                        <div class="modal-footer">
                                                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal"><span id="tr_cancel">Cancel</span></button>
                                                            <button type="submit" class="btn btn-danger"><i class="fas fa-trash"></i></button>
                                                        </div>
                                                    </form>
                                                </div>
                                            </div>
                                        </div> 
                                        
                                        <!-- Edit Operation Modal-->
                                        <div class="modal fade" id="editOperation{{oper.uuid|replace(' ','')}}" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="editOperationLabel" aria-hidden="true">
                                            <div class="modal-dialog modal-dialog-centered">

                                                <div class="modal-content">
                                                    <form method="post">
                                                        <div class="modal-header">
                                                            <h5 class="modal-title" id="editOperationLabel"><span id="tr_edit_oper_pos">Edit operation position</span> {{loop.index}} ?</h5>
                                                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                                        </div>

                                                        <div class="modal-body">
                                                            <input hidden type="text" name="mod" value="editoperation">
                                                            <input hidden type="text" name="uuid" value="{{oper.uuid}}">
                                                            
                                                            <h4><span id="tr_editing_oper">Editing operation</span> {{oper.operation}}</h4>
                                                            <!-- Check the type of operation and draw the form according to -->

                                                            {% if oper.operation == 'setdatatype' %}
                                                                <h6><span id="tr_old_params">Old parameters</span> {{oper.params}}</h6>
                                                                <!-- Add code for set datatype -->
                                                                <input hidden type="text" name="type" value="setdatatype">
                                                                <input hidden type="text" name="column" value="{{oper.params[0]}}">
                                                                <div>&MediumSpace;</div>
                                                                <div class="form-horizontal">
                                                                    <div class="form-group row">
                                                                        <!-- Data type -->
                                                                        <label for="coldatatype" class="col-sm-5 col-form-label"><span id="tr_new_data_type">New data type</span></label>
                                                                        <div class="col-sm-7">
                                                                            <!--input type="number" class="form-control text-left" id="coldataype" name="coldataype"></input-->
                                                                            <select class="form-control text-left" id="coldatatype" name="coldatatype">
                                                                                <option value="datetime" id="tr_datetime">Datetime</option>
                                                                                <option value="int" id="tr_integer">Integer</option>
                                                                                <option value="float" id="tr_float">Float</option>
                                                                            </select>
                                                                        </div>
                                                                    </div>
                                                                </div>

                                                            {% elif oper.operation == 'remcol' %}
                                                                <h6><span id="tr_old_params">Old parameters</span> {{oper.params}}</h6>
                                                                <!-- Add code for remove column -->
                                                                <input hidden type="text" name="type" value="remcol">
                                                                <div>&MediumSpace;</div>
                                                                <div class="form-horizontal">
                                                                    <div class="form-group row">
                                                                        <!-- Data type -->
                                                                        <label for="column" class="col-sm-5 col-form-label">Column</label>
                                                                        <div class="col-sm-7">
                                                                            <!--input type="number" class="form-control text-left" id="coldataype" name="coldataype"></input-->
                                                                            <select class="form-control text-left" id="column" name="column" value="{{oper.params}}">
                                                                                {% for title in titles %}
                                                                                <option value="{{title}}">{{title}}</option>
                                                                                {% endfor %}
                                                                            </select>
                                                                        </div>
                                                                    </div>
                                                                </div>

                                                            {% elif oper.operation == 'setcolumnname' %}
                                                                <h6><span id="tr_old_params">Old parameters</span> {{oper.params}}</h6>
                                                                <!-- Add code for set column name -->
                                                                <input hidden type="text" name="type" value="setcolumnname">
                                                                <input hidden type="text" name="column" value="{{oper.params[0]}}">
                                                                <div>&MediumSpace;</div>
                                                                <div class="form-horizontal">
                                                                    <div class="form-group row">
                                                                        <!-- New name -->
                                                                        <label for="minimum" class="col-sm-5 col-form-label"><span id="tr_new_name">Column new name</span></label>
                                                                        <div class="col-sm-7">
                                                                            <input type="text" class="form-control text-left" id="newname" name="newname" value="{{oper.params[1]}}"></input>
                                                                        </div>

                                                                        <div>&MediumSpace;</div>

                                                                    </div>

                                                                </div>

                                                            {% elif oper.operation == 'clearnull' %}
                                                                <!-- Add code for clearing nulls -->
                                                                <input hidden type="text" name="type" value="clearnull">
                                                                <h4>This operation does not support editing. Please delete the operation.</h4>

                                                            {% elif oper.operation == 'filtercol' %}
                                                                <h6><span id="tr_old_params">Old parameters</span> {{oper.params}}</h6>
                                                                <!-- Add code for filtering columns -->
                                                                <input hidden type="text" name="type" value="filtercol">
                                                                <input hidden type="text" name="column" value="{{oper.params[0]}}">
                                                                <div>&MediumSpace;</div>
                                                                <div class="form-horizontal">
                                                                    <div class="form-group row">
                                                                        <!-- Operator -->
                                                                        <!--label for="minimum" class="col-sm-5 col-form-label">Minimum value inclusive</label>
                                                                        <div class="col-sm-7">
                                                                            <input type="number" class="form-control text-left" id="minimum" name="minimum" step="0.1"></input>
                                                                        </div-->

                                                                        <!-- Operator -->
                                                                        <label for="operatortype" class="col-sm-5 col-form-label"><span id="tr_operator">Operator</span></label>
                                                                        <div class="col-sm-7">
                                                                            <!--input type="number" class="form-control text-left" id="coldataype" name="coldataype"></input-->
                                                                            <select class="form-control text-left" id="operatortype" name="operatortype" value="{{oper.params[1]}}">
                                                                                <option value="<">&lt;</option>
                                                                                <option value="<=">&lt;=</option>
                                                                                <option value=">">&gt;</option>
                                                                                <option value=">=">&gt;=</option>
                                                                            </select>
                                                                        </div>

                                                                        <div>&MediumSpace;</div>

                                                                        <!-- Value -->
                                                                        <label for="filtervalue" class="col-sm-5 col-form-label"><span id="tr_value">Value</span></label>
                                                                        <div class="col-sm-7">
                                                                            <input type="number" class="form-control text-left" id="filtervalue" name="filtervalue" value ={{oper.params[2]}} step="0.01"></input>
                                                                        </div>
                                                                    </div>

                                                                </div>
                                                            
                                                            {% elif oper.operation == 'remoutliers' %}
                                                                <h6><span id="tr_old_params">Old parameters</span> {{oper.params}}</h6>
                                                                <!-- Add code for filtering columns -->
                                                                <input hidden type="text" name="type" value="remoutliers">
                                                                <input hidden type="text" name="column" value="{{oper.params[0]}}">
                                                                <div>&MediumSpace;</div>
                                                                <div class="form-horizontal">
                                                                    <div class="form-group row">
                                                                        
                                                                        <div class="col-sm-12">
                                                                            <div class="form-check form-switch">
                                                                                <input id="upperOutliers" class="form-check-input" type="checkbox" name="upperOutliers" {% if oper.params[1] == True %} checked {% endif %}>
                                                                                <label for="upperOutliers" class="form-check-label"><span id="tr_upper_outlier">Remove upper outliers</span></label>
                                                                            </div>
                                                                        </div>
                                                                        
                                                                        <div class="col-sm-12">
                                                                            <div class="form-check form-switch">
                                                                                <input id="lowerOutliers" class="form-check-input" type="checkbox" name="lowerOutliers" {% if oper.params[2] == True %} checked {% endif %}>
                                                                                <label for="lowerOutliers" class="form-check-label"><span id="tr_lower_outlier">Remove lower outliers</span></label>
                                                                            </div>
                                                                        </div>

                                                                    </div>

                                                                </div>

                                                            {% elif oper.operation == 'script' %}
                                                                <!-- Add code for script -->
                                                                <input hidden type="text" name="type" value="script">
                                                                <div class="form-horizontal">
                                                                    <div class="form-group row">
                                                                        <!-- Code -->
                                                                        <label for="editcode" class="col-sm-5 col-form-label">Code</label>
                                                                        <textarea class="form-control" type="text" name="editcode" id="editcode{{oper.uuid|replace('-','')}}" rows="6">
                                                                            {{oper.params[0]}}
                                                                        </textarea>
                                                                    </div>
                                                                </div>

                                                                <!-- Scripts for code editor -->
                                                                <script>

                                                                    function convertToRtf(plain) {
                                                                        plain = plain.replace(/\n/g, "\\par\n");
                                                                        return "{\\rtf1\\ansi\\ansicpg1252\\deff0\\deflang2057{\\fonttbl{\\f0\\fnil\\fcharset0 Microsoft Sans Serif;}}\n\\viewkind4\\uc1\\pard\\f0\\fs17 " + plain + "\\par\n}";
                                                                    }

                                                                    const editor{{oper.uuid|replace('-','')}} = CodeMirror.fromTextArea(document.getElementById("editcode{{oper.uuid|replace('-','')}}"), { 
                                                                    mode: { 
                                                                        name: "python", 
                                                                        version: 3, 
                                                                        singleLineStringErrors: false
                                                                    },
                                                                    theme: "monokai",
                                                                    lineNumbers: true,
                                                                    indentUnit: 4, 
                                                                    matchBrackets: true
                                                                    });

                                                                    editor{{oper.uuid|replace('-','')}}.refresh();
                                                                
                                                                </script>

                                                            {% endif %}

                                                        </div>

                                                        <div class="modal-footer">
                                                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal"><span id="tr_cancel">Cancel</span></button>
                                                            <button type="submit" class="btn btn-success"><i class="fas fa-check"></i></button>
                                                        </div>
                                                    </form>
                                                </div>
                                            </div>
                                        </div> 

                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}    
    </div>
</div>
<div class="row">
    <div class="col-12">
        {% if uploaded %}
            <div class="card bg-light ms-4 me-4 mb-4">
            <div class="card-header">
                <i class="fa-solid fa-list fa-database"></i><span id="tr_dataset_preview"> Dataset preview (only first 10 records)</span>
            </div>
            <div class="card-body">
                <p class="card-text">
                    <div class="table-responsive" id="tour-train-import-dataview">
                        {% for table in tables %}
                            {{ table|safe }}
                        {% endfor %}
                    </div>  
                </p>
            </div>
            </div>
        {% endif %}            
    </div>
</div>
<!-- end content-->

{% if uploaded %}

<!-- Scripting Modal -->
<div class="modal fade" id="script" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="scriptLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable">

        <div class="modal-content">
            <form method="post">
                <div class="modal-header">
                    <h5 class="modal-title" id="scriptLabel"><span id="tr_apply_python_script_oper">Apply a Python script data operation</span></h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>

                <div class="modal-body">
                    <input hidden type="text" name="mod" value="script">

                    <div class="container">
                        <div class="row">
                            <!-- Code column -->
                            <div class="col-xl-8">
                                <div class="form-horizontal">
                                    <div class="form-group row">
                                        
                                        <!-- Code textarea -->
                                        <label for="code" class="col-sm-5 col-form-label"><h6><span id="tr_script_code">Script code:</span></h6></label>

                                        <div class="col-sm-12" ondrop="drop(event)" ondragover="allowDrop(event)">
                                            <textarea id="code" name="code"></textarea>
                                        </div>

                                    </div>
                                </div>
                            </div>

                            <div class="col-xl-4">

                                <div class="container mt-3 overflow-scroll"  style="max-height: 325px;">
                                    <h6><span id="tr_available_var_func">Available variables and functions</span></h6>
                                    <div id="accordion">
                                        <div class="card">
                                            <div class="card-header">
                                            <a class="btn" data-bs-toggle="collapse" href="#collapseOne" draggable="false">
                                                <span id="tr_data_variables">Data variables</span>
                                            </a>
                                            </div>
                                            <div id="collapseOne" class="collapse" data-bs-parent="#accordion">
                                            <div class="card-body">
                                                <ul class="list-group">
                                                    {% for title in titles %}
                                                    <li class="list-group-item" draggable="true" ondragstart="drag(event)">
                                                        <row class="d-flex justify-content-between align-items-center">
                                                            <h6>{{title}}</h6>
                                                            <span class="badge bg-success rounded-pill">{{datatypes[loop.index0]}}</span>
                                                        </row>
                                                        <row><code>col['{{title}}']</code></row>
                                                    </li>
                                                    {% endfor %}
                                                </ul>
                                            </div>
                                            </div>
                                        </div>
                                        <div class="card">
                                            <div class="card-header">
                                            <a class="collapsed btn" data-bs-toggle="collapse" href="#collapseTwo">
                                                <span id="tr_custom_functions">Custom Functions</span>
                                            </a>
                                            </div>
                                            <div id="collapseTwo" class="collapse" data-bs-parent="#accordion">
                                            <div class="card-body">
                                                <ul class="list-group">
                                                    <li class="list-group-item">
                                                        <h6><span id="tr_func_add_column">Add column to dataset</span></h6>
                                                        <code>context.AddColumn(baseColumn, name)</code>
                                                    </li>
                                                    <li class="list-group-item">
                                                        <h6><span id="tr_func_agg_week">Aggregate per week</span></h6>
                                                        <code>context.AggWeek(dateColumn, mode='sum')</code>
                                                    </li>
                                                    <li class="list-group-item">
                                                        <h6><span id="tr_func_agg_month">Aggregate per month</span></h6>
                                                        <code>context.AggMonth(dateColumn, mode='sum')</code>
                                                    </li>
                                                    <li class="list-group-item">
                                                        <h6><span id="tr_func_expand_cat">Expand categories to columns</span></h6>
                                                        <code>context.ExpandCategories(column)</code>
                                                    </li>
                                                    <li class="list-group-item">
                                                        <h6><span id="tr_func_rep_nan_value">Replace NaN with number</span></h6>
                                                        <code>context.ReplaceNaN(column , value)</code>
                                                    </li>
                                                    <li class="list-group-item">
                                                        <h6><span id="tr_func_rep_nan_avg">Replace NaN with average</span></h6>
                                                        <code>context.ReplaceNaN_Average(column)</code>
                                                    </li>
                                                    <li class="list-group-item">
                                                        <h6><span id="tr_func_rep_nan_med">Replace NaN with median</span></h6>
                                                        <code>context.ReplaceNaN_Median(column)</code>
                                                    </li>
                                                    <li class="list-group-item">
                                                        <h6><span id="tr_func_rep_nan_mode">Replace NaN with mode</span></h6>
                                                        <code>context.ReplaceNaN_Mode(column)</code>
                                                    </li>
                                                    <li class="list-group-item">
                                                        <h6><span id="tr_func_rem_duplicated">Remove duplicated entries</span></h6>
                                                        <code>context.RemoveDuplicates()</code>
                                                    </li>
                                                    <!--li class="list-group-item">
                                                        <h6>Set column name</h6>
                                                        <code>context.SetColumnName(oldName, newName)</code>
                                                    </li-->
                                                </ul>
                                            </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                        </div>
                        <br>
                        <div class="row overflow-scroll" style="max-height: 150px;">
                            <div class="col-xl-12 ">
                                <!-- Help column -->
                                <span id="tr_usage_examples">Some usage examples:</span>
                                    <ol class="list-group list-group-numbered">
                                        <li class="list-group-item d-flex justify-content-between align-items-start">
                                            <div class="ms-2 me-auto">
                                                <div class="fw-bold"><span id="tr_ex_copy_col">Copy a specific column</span></div>
                                                <span id="tr_ex_copy_col_desc">To create a new column based on other just perform the procedure</span> <code> context.AddColumn('BasedColumnName','NewColumnName')</code>
                                            </div>
                                        </li>
                                        <li class="list-group-item d-flex justify-content-between align-items-start">
                                            <div class="ms-2 me-auto">
                                                <div class="fw-bold"><span id="tr_ex_copy_col_calc">Create new column with calculated values</span></div>
                                                <span id="tr_ex_copy_col_calc_desc">To add a new calculated column use the following syntax</span><code> context.processedData['new_column_name'] = context.processedData['column_a'] + context.processedData['column_b']</code>
                                            </div>
                                        </li>
                                        <li class="list-group-item d-flex justify-content-between align-items-start">
                                            <div class="ms-2 me-auto">
                                                <div class="fw-bold"><span id="tr_ex_week_from_date">Create week number from date</span></div>
                                                <span id="tr_ex_week_from_date_desc">Ensure first that the date column is set with datetime format. To add a new calculated column with the week number from date use the following syntax</span><code> context.processedData['week_num'] = context.processedData['date'].dt.week</code>
                                            </div>
                                        </li>
                                        <!--li class="list-group-item d-flex justify-content-between align-items-start">
                                            <div class="ms-2 me-auto">
                                                <div class="fw-bold">Replace NaN by zero</div>
                                                The clear nulls removes the rows containing NaN values. However you can use this code to replace NaN by a fixed value on specific columns <code>context.processedData['column'] = context.processedData['column'].fillna(0, inplace=True)</code>
                                            </div>
                                        </li-->
                                        <!--li class="list-group-item d-flex justify-content-between align-items-start">
                                            <div class="ms-2 me-auto">
                                                <div class="fw-bold">Units conversion from kW to MW</div>
                                                The values can be recalculated for instance to change the units of measurement. To change from kW to MW just apply the following code <code>context.processedData['data_in_kw'] = context.processedData['data_in_kw'] / 1000</code>
                                            </div>
                                        </li-->
                                        <!--li class="list-group-item d-flex justify-content-between align-items-start">
                                            <div class="ms-2 me-auto">
                                                <div class="fw-bold">Agregate the dataset from daily to weekly level</div>
                                                The dataset can be agrregated at the weekly level with mode options (mode='sum') for summing or (mode='mean') for averaging the values of the columns. To aggregate apply the following code <code>context.AggWeek(date_column, mode)</code>
                                            </div>
                                        </li-->
                                        <li class="list-group-item d-flex justify-content-between align-items-start">
                                            <div class="ms-2 me-auto">
                                                <div class="fw-bold"><span id="tr_ex_encode_features">Encode categorical features</span></div>
                                                <span id="tr_ex_encode_features_desc">This function encodes categorical features. For example it transforms ['low', 'mid', 'high', 'mid', 'low'] into [0, 1, 2, 1, 0]. To transform the data apply the following code</span><code> context.LabelEncoder(column)</code>
                                            </div>
                                        </li>
                                    </ol>
                            </div>
                        </div>
                    </div>
                    
                    <div>&MediumSpace;</div>

                    <p>⚠️ <span id="tr_msg_code_not_validated">The code is not validated before executed. Strange behaviours may occur due to misspelling. Python is case-sensitive. Please use it carefully.</span></p>

                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal"><span id="tr_cancel">Cancel</span></button>
                    <button type="submit" class="btn btn-success"><i class="fas fa-play"></i></button>
                </div>
            </form>
        </div>
    </div>
</div>

<!--Correlation Matrix Modal -->
<div class="modal fade" id="correlation" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="correlationLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable">

        <div class="modal-content">
            <form method="post">
                <div class="modal-header">
                    <h5 class="modal-title" id="correlationLabel"><span id="tr_var_correlation_matrix">Variables correlation matrix</span></h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>

                <div class="modal-body">
                    <div class="container">

                        <canvas id="matrix"></canvas>

                        <script>
                            // https://chartjs-chart-matrix.pages.dev/
                            //Prepare Dataset
                            jsCorrData = []

                            {% for line in matrixData %}
                                jsCorrData.push({{line|tojson}})
                            {% endfor %}


                            // Titles list
                            jsCorrTitlesData = []
                            {% for title in matrixTitles %}
                                jsCorrTitlesData.push({{title|tojson}})
                            {% endfor %}

                            // console.log(jsCorrTitlesData)
                            // console.log(jsCorrData)

                            // Data
                            var data = {
                                labels: ['Matrix_Chart'],
                                datasets: [{
                                    data: jsCorrData,
                                    backgroundColor({raw}){
                                        //const alpha = ((0 + raw.v) / 1);
                                        const alpha = (raw.v + 1)/2;
                                        return blend_colors("#fbde4a", "#01a7cb", alpha)
                                    },
                                    borderColor: 'rgba(75, 192, 192, 1)',
                                    borderWidth: 1,
                                    width: ({chart}) => (chart.chartArea || {}).width / {{matrixTitles|length}} -1, //number of X
                                    height: ({chart}) => (chart.chartArea || {}).height / {{matrixTitles|length}} -1, //number of Y
                                }]
                            };

                            // config 
                            var config = {
                                type: 'matrix',
                                data,
                                options: {
                                    plugins: {
                                        legend: false,
                                        tooltip: {
                                            displayColors: false,
                                            callbacks: {
                                                title() {
                                                    return '';
                                                },
                                                label(context) {
                                                    const v = context.dataset.data[context.dataIndex];
                                                    return ['X: ' + v.x, 'Y: ' +v.y, 'CORR: ' + (v.v * 100).toFixed(0)+'%'];
                                                },
                                            },
                                        },
                                    },
                                    scales: {
                                        x: {
                                            type: 'category',
                                            labels: jsCorrTitlesData,
                                            ticks: {
                                                display: true,
                                            },
                                            grid: {
                                                display: false,
                                            },
                                        },
                                        y: {
                                            type: 'category',
                                            labels: jsCorrTitlesData,
                                            offset: true,
                                            ticks: {
                                                display: true,
                                            },
                                            grid: {
                                                display: false,
                                            },
                                        },
                                    },
                                },
                            };

                            // render init block
                            const matrixChart = new Chart(
                                document.getElementById('matrix'),
                                config,
                            );

                        </script>

                    </div>
                    
                    <div>&MediumSpace;</div>

                </div>

                <!--div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div-->
            </form>
        </div>
    </div>
</div>

<!--Scatter Plot Modal -->
<div class="modal fade" id="scatterplot" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="scatterLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable">

        <div class="modal-content">
            <form method="post">
                <div class="modal-header">
                    <h5 class="modal-title" id="scatterLabel"><span id="tr_scatter_plot">Scatter plot</span></h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>

                <div class="modal-body">
                    <div class="container">

                        <div class="row">
                            <div class="col-lg-2">
                                <div class="input-group input-group-sm">
                                    <label class="input-group-text" for="selectedXVariable"><i class="fas fa-x"></i></label>
                                    <select class="form-select" id="selectedXVariable">
                                        <option selected>Choose one variable...</option>
                                        {% for title in titles %}
                                            <option value={{loop.index-1}}>{{title}}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>

                            <div class="col-lg-2">
                                <div class="input-group input-group-sm">
                                    <label class="input-group-text" for="selectedYVariable"><i class="fas fa-y"></i></label>
                                    <select class="form-select" id="selectedYVariable">
                                        <option selected>Choose one variable...</option>
                                        {% for title in titles %}
                                            <option value={{loop.index-1}}>{{title}}</option>
                                        {% endfor %}
                                    </select>
                                </div>  
                            </div>

                            <div class="col-lg-2">
                                <div class="input-group input-group-sm">
                                    <label class="input-group-text" for="selCVariable"><i class="fas fa-palette"></i></label>
                                    <select class="form-select" id="selCVariable">
                                    <option selected>Choose one variable...</option>
                                        {% for title in titles %}
                                            <option value={{loop.index-1}}>{{title}}</option>
                                        {% endfor %}
                                    </select>
                                </div>               
                            </div>

                            <div class="col-lg-1">
                                <div class="input-group input-group-sm">
                                    <label class="input-group-text" for="colorInput"><i class="fas fa-tint"></i></label>
                                    <input type="color" class="form-control form-control-color" id="colorInput" value="#fbde4a" title="Choose initial color">
                                </div>                
                            </div>

                            <div class="col-lg-1">
                                <div class="input-group input-group-sm">
                                    <label class="input-group-text" for="colorInput2"><i class="fas fa-tint"></i></label>
                                    <input type="color" class="form-control form-control-color" id="colorInput2" value="#01a7cb" title="Choose final color">
                                </div>              
                            </div>

                            <div class="col-lg-2">
                                <div class="input-group input-group-sm">
                                    <label class="input-group-text" for="polyDegree"><i class="fas fa-superscript"></i></label>
                                    <input type="number" class="form-control form-control-color" id="polyDegree" value="3" step="1" min="2" max="6" title="Polynomial degree">
                                </div>              
                            </div>

                            <div class="col-lg-2">
                                <div class="d-grid gap-2">
                                    <button type="button" class="btn btn-primary btn-sm" data-bs-toggle="dropdown" onclick="UpdateChart()"><i class="fas fa-refresh"></i><span id="tr_update"> Update</span></button>
                                </div>
                            </div>

                        </div>

                        <br>

                        <canvas id="myChart" style="width:100%;height:100%;max-height:500px;"></canvas>

                        <canvas id="myCanvas" style="width:100%;height:100%;max-height:15px;"></canvas>

                        <div class="container" id="color_variable_container" hidden>
                            <!-- Double slider filter -->
                            <div class="row">
                                <!--label for="filterColorRange" class="form-label">Filter color variable</label-->
                                <input type="range" class="form-range" min="0" max="100" step="10" defaultValue="100" id="filterColorRange" onchange = "changeValue(this.value)">
                             </div>
                            
                            <!-- End of Double slider -->

                            <div class="row">
                                <div class="col-2">Min</div>
                                <div class="col-8 text-center">Color variable</div>
                                <div class="col-2" style="text-align: right;">Max</div>
                            </div>
                            <div class="row">
                                <div class="col-2"><h6 id="minValue">0</h6></div>
                                <div class="col-8 text-center"><h6 id="variableName">[Variable Name]</h6></div>
                                <div class="col-2" style="text-align: right;"><h6 id="maxValue">100</h6></div>
                            </div>

                        </div>
                        
                        <script>

                            var xyValues = [
                                {x:0, y:0}
                            ]

                            var xArray = []
                            var yArray = []

                            var colorPoints = [
                            '#91d754'
                            ]


                                // Regression
                                var regressionData = [
                                    {x:0, y:0},
                                    {x:1, y:1}
                                ];

                                // Regression
                                var polyRegressionData = [
                                    {x:0, y:0},
                                    {x:1, y:1}
                                ];

                                // Update the labels
                                var labelX = document.getElementById('selectedXVariable').options[document.getElementById("selectedXVariable").selectedIndex ].text;
                                var labelY = document.getElementById('selectedYVariable').options[document.getElementById("selectedYVariable").selectedIndex ].text;

                                const ctx = document.getElementById('myChart').getContext('2d');

                                const myChart = new Chart("myChart", {
                                    
                                    data: {
                                        datasets: [
                                            {
                                                label: 'Linear regression',
                                                data: regressionData,
                                                borderColor: 'red',
                                                backgroundColor: 'transparent',
                                                type: 'line',
                                                borderWidth: 1,
                                                pointRadius: 0,
                                                borderDash: [10,10],
                                                //xAxisID: 'x2',
                                            },{
                                                label: 'Polynomial regression',
                                                data: polyRegressionData,
                                                borderColor: 'blue',
                                                backgroundColor: 'transparent',
                                                type: 'line',
                                                borderWidth: 1,
                                                pointRadius: 0,
                                                borderDash: [10,2,10],
                                                //xAxisID: 'x2'
                                            },{
                                                label: 'Scatter plot',
                                                type: "scatter",
                                                pointRadius: 3,
                                                pointBackgroundColor: colorPoints,
                                                pointsBorderColor: colorPoints,
                                                data: xyValues
                                        }]
                                    },
                                    options:{
                                        elements:{
                                            point:{
                                                borderColor: colorPoints,
                                            }
                                        },
                                        plugins:{
                                            legend: {
                                                display: true
                                            },
                                            zoom:{
                                                zoom:{
                                                    wheel:{
                                                        enabled: true,
                                                        modifierKey: 'ctrl',
                                                    },
                                                    drag:{
                                                        enabled: true,
                                                        modifierKey: 'ctrl',
                                                    },
                                                    pinch:{
                                                        enabled: true
                                                    },
                                                    mode: 'xy',
                                                }
                                            },
                                            tooltip: {
                                                callbacks: {
                                                    label: (context) => {

                                                        const regressionFormula = [
                                                            `X (${labelX}): ${context.parsed.x}`,
                                                            `Y (${labelY}): ${context.parsed.y}`,
                                                            `Color (${variable}): ${context.raw.z}`,
                                                            ``,
                                                            `Regressions expressions:`,
                                                            `Linear Y = ${m +"x + " + b}`,
                                                            `Polynomial Y = ${expression}`,
                                                        ]

                                                        return regressionFormula
                                                    }
                                                }

                                            },
                                        },   
                                        responsive: true,
                                        scales: {
                                            x: {
                                                type: 'linear',
                                                title: {
                                                    display: true,
                                                    text: labelX,
                                                }
                                            },
                                            y: {
                                                type: 'linear',
                                                title: {
                                                    display: true,
                                                    text: labelY,
                                                },
                                            },
                                        }
                                    }
                                });
                            
  
                            // Get the data from Jinja2 to Javascript
                            jsData = []
                            {% if rawdata is defined %}
                                {% for row in rawdata %}
                                    jsData.push({{row|tojson}})             
                                {% endfor %}
                            {% endif %}

                            function UpdateChart(){

                                singleColor = false

                                myChart.resetZoom(mode='none')

                                const x_variable = document.getElementById('selectedXVariable').value;
                                const y_variable = document.getElementById('selectedYVariable').value;
                                const color_variable = document.getElementById('selCVariable').value;
                                const polyDegree = document.getElementById('polyDegree').value;

                                const sel_color = document.getElementById('colorInput').value;
                                const sel_color2 = document.getElementById('colorInput2').value;

                                var minColor = null;
                                var maxColor = null;

                                if (x_variable=="Choose one variable..."){
                                    alert("Please select one variable to be assigned to X axis.");
                                    return
                                }
                                    
                                if (y_variable=="Choose one variable...")
                                {
                                    alert("Please select one variable to be assigned to Y axis.");
                                    return
                                }

                                if (color_variable=="Choose one variable...")
                                {
                                    singleColor = true;
                                } else {
                                    //Calculate the Min and Max of the variable
                                    minColor = null;
                                    maxColor = null;
                                    jsData.forEach(element => {
                                        if (minColor == null){
                                            minColor = element[color_variable]
                                        }

                                        if (maxColor == null){
                                            maxColor = element[color_variable]
                                        }

                                        if (element[color_variable] < minColor){
                                            minColor = element[color_variable]
                                        }
                                        if (element[color_variable] > maxColor){
                                            maxColor = element[color_variable]
                                        } 
                                    });
                                }

                                xyValues.length = 0
                                colorPoints.length = 0
                                

                                jsData.forEach(line => {
                                    // console.log("X:", line[x_variable], "Y:", line[y_variable])

                                    // Cores dos pontos
                                    if (singleColor == true){
                                        colorPoints.push(sel_color)

                                        xyValues.push({
                                            'x': line[x_variable],
                                            'y': line[y_variable],
                                            'z': 0
                                        })
                                        

                                    } else {

                                        xyValues.push({
                                            'x': line[x_variable],
                                            'y': line[y_variable],
                                            'z': line[color_variable]
                                        })

                                        // Criar linearização de cor
                                        if (line[color_variable] == 0){
                                            colorPoints.push('#000000')
                                        } else {
                                            // colorPoints.push(calculateColor(minColor, maxColor, line[color_variable], sel_color))
                                            perc = (line[color_variable]-minColor)/(maxColor-minColor)
                                            if (perc <0.1){
                                                perc = 0.1
                                            }
                                            colorPoints.push(blend_colors(sel_color, sel_color2, perc))
                                        } 
                                    }

                                    // Update canvas
                                    const c = document.getElementById("myCanvas");
                                    const ctx = c.getContext("2d");
                                    const grad = ctx.createLinearGradient(0,0,280,0);
                                    // grad.addColorStop(0, newShade(sel_color, 40));
                                    // grad.addColorStop(1, newShade(sel_color, 140));
                                    grad.addColorStop(0, sel_color);
                                    grad.addColorStop(1, sel_color2);
                                    ctx.fillStyle = grad;
                                    ctx.fillRect(0,0,500,130);

                                    // Update the values and names
                                    const min = document.getElementById("minValue")
                                    const max = document.getElementById("maxValue")
                                    const name = document.getElementById("variableName")
                                    variable = document.getElementById('selCVariable').options[document.getElementById("selCVariable").selectedIndex].text

                                    if (minColor != null && maxColor != null){
                                        min.innerText = minColor.toFixed(2)
                                        max.innerText = maxColor.toFixed(2)
                                        name.innerText = variable
                                        c.hidden = false
                                        document.getElementById('color_variable_container').hidden = false
                                    } else {
                                        c.hidden = true
                                        document.getElementById('color_variable_container').hidden = true
                                    }
                                    
                                });

                                // Update the labels
                                labelX = document.getElementById('selectedXVariable').options[document.getElementById("selectedXVariable").selectedIndex ].text;
                                labelY = document.getElementById('selectedYVariable').options[document.getElementById("selectedYVariable").selectedIndex ].text;

                                // console.log(labelX, " - ", labelY)
                                myChart.options.scales.y.title.text = labelY
                                myChart.options.scales.x.title.text = labelX

                                // Calculate the linear regression
                                linearRegression()
                                regressionData.length = 0
                                // console.log("Regression equation: y=" + m.toFixed(3) +"x +" + b.toFixed(3))

                                // Get the min and max of th X axis
                                tempXMin=1000000
                                tempXMax=-1000000

                                xArray.length = 0
                                yArray.length = 0

                                xyValues.forEach(line => {
                                    //console.log("Line: " + line.x)
                                    if (line.x < tempXMin){
                                        tempXMin = line.x
                                    }
                                    if (line.x > tempXMax){
                                        tempXMax = line.x
                                    }

                                    // set the X and Y array for polynomial
                                    xArray.push(line.x)
                                    yArray.push(line.y)
                                })

                                // Polymonial regression
                                var poly = Polyfit(xArray, yArray)
                                var solver = poly.getPolynomial(parseInt(polyDegree))
                                expression = poly.toExpression(parseInt(polyDegree))

                                polyRegressionData.length = 0
                                // Update regression with 100 points
                                for (let i=tempXMin; i<tempXMax; i += (tempXMax-tempXMin)/50){
                                    polyRegressionData.push({x: i, y: solver(i)})
                                }

                                regressionData.push({x: tempXMin, y: (m * tempXMin) + b})
                                regressionData.push({x: tempXMax, y: (m * tempXMax) + b})

                                // Update the range filter data
                                range = document.getElementById('filterColorRange')
                                step = (maxColor - minColor) / 20;
                                range.step = step;
                                range.min = minColor + step;
                                range.max = maxColor+1;
                                range.value = maxColor;
                                range.defaultValue = maxColor;

                                myChart.data.datasets[2].data = xyValues;
                                myChart.data.datasets[2].pointBackgroundColor = colorPoints;
                                myChart.data.datasets[2].pointsBorderColor = colorPoints;
                                myChart.options.elements.point.borderColor = colorPoints;

                                // Update the chart
                                myChart.update()
                            }

                            function linearRegression(){
                                var xsum = 0;
                                var ysum = 0;
                                for (var i = 0; i < xyValues.length; i ++) {
                                    xsum += xyValues[i].x;
                                    ysum += xyValues[i].y;
                                }
                                var xmean = xsum / xyValues.length;
                                var ymean = ysum / xyValues.length;
                            
                                var num = 0;
                                var denom = 0;
                                for (var i = 0; i < xyValues.length; i ++) {
                                    var x = xyValues[i].x
                                    var y = xyValues[i].y
                                    num += (x - xmean) * (y - ymean);
                                    denom += (x - xmean) * (x - xmean);
                                }
                            
                                m = num / denom
                                b = ymean - (m * xmean);
                            }

                            function changeValue(newVal){
                                let filteredValues = [];
                                let filteredColorPoints = [];

                                for(let i = 0; i<xyValues.length; i++){
                                    if( xyValues[i].z <= newVal){
                                        filteredValues.push(xyValues[i]);
                                        filteredColorPoints.push(colorPoints[i]);
                                    }
                                }

                                filterText = document.getElementById("variableName")
                                const color_variable = document.getElementById('selCVariable').options[document.getElementById("selCVariable").selectedIndex ].text;
                                range = document.getElementById('filterColorRange')

                                if (parseFloat(newVal) < parseFloat(range.max)){
                                    filterText.innerText = color_variable + " ( < " + newVal + ")";
                                } else {
                                    filterText.innerText = color_variable;
                                }

                                //console.log("New val: " + newVal + " Max:" + range.max)

                                myChart.data.datasets[2].data = filteredValues;
                                myChart.data.datasets[2].pointBackgroundColor = filteredColorPoints;
                                myChart.data.datasets[2].pointsBorderColor = filteredColorPoints;
                                myChart.options.elements.point.borderColor = filteredColorPoints;

                                myChart.update('none');

                            }

                        </script>
                        <!-- End of chart -->
                        
                    </div>

                </div>
            </form>
        </div>
    </div>
</div>

<!--Data visualization Modal -->
<div class="modal fade" id="visualization" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="visualizationLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable">

        <div class="modal-content ">
            <div class="modal-header">
                <h5 class="modal-title" id="visualizationLabel"><span id="tr_data_exploration">Data Exploration</span> - Powered by PyGWalker</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>

            <div class="modal-body overflow-scroll">
                {{ html_str|safe }}                    
            </div>
        </div>
    </div>
</div>

<!-- Console Area -->
<div id="console" class="console">
    <button class="open-button"onclick="openForm()" id='tour-datastudio-console'><img src="../static/img/console.png" width="30" height="30"></button>

    <div class="chat-popup" id="myForm">
        <div class="form-container" id="consolePrompt">
        <h3><i class="fa-solid fa-window-maximize"></i> <span id="tr_console">Console</span></h3>
        <h6><span id="tr_terminal_output">Data studio terminal output</span></h6>

        <textarea data-provide="markdown" placeholder="Data studio output will appear here..." name="msg" readonly id="consoleOutput">
            {%- for line in console -%}
            {{line|e}}
            {%- endfor %}        
        </textarea>

        <button type="button" class="btn btn-success cancel" onclick="closeForm()"><span id="tr_close">Close</span></button>
    </div>
    </div>
</div>
{% endif %}

{% endblock %}

{% block scripts %}

<script src="https://cdn.jsdelivr.net/npm/hammerjs@2.0.8"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1/dist/chartjs-plugin-zoom.min.js"></script>

<!-- Editor code -->
<script>
    
    let pythonEditor = null;

    $(document).ready(function(){

        pythonEditor = CodeMirror.fromTextArea(document.getElementById("code"), { 
        mode: { 
            name: "python", 
            version: 3, 
            singleLineStringErrors: false
        },
        theme: "monokai",
        lineNumbers: true,
        indentUnit: 4, 
        matchBrackets: true
        });

        pythonEditor.setValue('# Use the right menu to easily copy paste the variables and functions.\r\n')
        pythonEditor.refresh();

        var scriptModal = document.getElementById("script");
        var textArea = document.getElementById("code");

        scriptModal.addEventListener('shown.bs.modal', function() {
            textArea.focus()
        });
    });

    var dropCode = "";

    // Drag and Drop feature for variables and functions
    function drag(ev){
        //console.log(ev);
        if (ev.type === "dragstart") {
            code = ev.srcElement.querySelectorAll('code');
            dropCode = code[0].innerText;
        }
    }

    function drop(ev){
        //console.log(ev);
        if (ev.type === "drop") {
            pythonEditor.replaceRange(dropCode, CodeMirror.Pos(pythonEditor.lastLine()));
            pythonEditor.refresh();
        }
    }

    function allowDrop(ev){
        ev.preventDefault();
    }


</script>

<!-- Accentuate the NaN value in table-->
<script>
    const cells = document.querySelectorAll('td');
    // console.log(cells)

    for (let i=0; i < cells.length; i++){
        if(cells[i].innerText == "NaN"){
            cells[i].innerText = "⚠️"
        }
    }
    
</script>
<script src="../static/js/intro.min.js"></script>
<script src="../static/js/tour-datastudio.js"></script>
<script src="../static/js/console.js"></script>
{% endblock %}
